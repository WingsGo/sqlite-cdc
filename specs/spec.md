# 功能规格：SQLite CDC 同步引擎

**功能分支**: `001-sqlite-cdc-sync`
**创建日期**: 2026-02-07
**状态**: Draft
**输入**: 用户描述: "实现一个sqlite到MySQL、Oracle的CDC方案，要求支持存量和增量同步，保证最终一致性，同步的过程不影响主链路，如果同步失败需要提示用户，需要支持作为PyPI发布的三方库，以及可以通过CLI作为独立程序运行，支持通过配置支持不同字段名的映射，要求使用python作为编程语言"

## 用户场景与测试

### 用户场景 1 - 存量数据初次同步 (Priority: P1)

作为数据库管理员，我需要将现有 SQLite 数据库的全部数据一次性同步到 MySQL/Oracle，以便为后续增量同步建立基础。

**为何此优先级**: 存量同步是 CDC 方案的第一步，没有完整的历史数据基准，增量同步将失去意义。这是 MVP 的核心功能。

**独立测试**: 可以独立测试：配置源 SQLite 库和目标 MySQL/Oracle 库，运行初始同步命令，验证目标库数据与源库完全一致。

**验收场景**:

1. **Given** 源 SQLite 数据库包含 10 张表共 100 万条记录，**When** 执行初始同步命令，**Then** 目标 MySQL/Oracle 数据库应在可接受时间内完成全部数据复制，且数据校验一致
2. **Given** 源数据库某表有大字段（BLOB/TEXT），**When** 执行初始同步，**Then** 大字段数据应完整迁移，无截断或损坏
3. **Given** 同步过程中源数据库正在被写入，**When** 存量同步完成，**Then** 系统应记录同步快照点，确保后续增量从正确位置开始

---

### 用户场景 2 - 实时增量同步 (Priority: P1)

作为应用开发者，我需要 SQLite 数据库的变更（INSERT/UPDATE/DELETE）实时同步到目标数据库，以保持数据最终一致性。

**为何此优先级**: 增量同步是 CDC 的核心价值，确保目标库与源库保持同步。这是系统的核心能力。

**实现机制**: 通过审计日志表 `_cdc_audit_log` 捕获变更。应用层使用包装后的连接执行写入，自动将变更记录到审计表（与业务数据同一事务）。后台线程轮询审计表，批量消费并同步到目标库。

**独立测试**: 可以独立测试：启动增量同步引擎，通过包装连接在 SQLite 执行增删改操作，验证审计表生成记录且目标库在合理延迟内反映相同变更。

**验收场景**:

1. **Given** 增量同步已启动，**When** 通过 CDC 包装连接在 SQLite 插入一行数据，**Then** 审计表应生成对应记录，且目标数据库应在 5 秒内出现相同记录
2. **Given** 增量同步已启动，**When** 通过 CDC 包装连接在 SQLite 更新一行数据，**Then** 审计表应记录变更前后的数据，且目标数据库应在 5 秒内同步更新
3. **Given** 增量同步已启动，**When** 通过 CDC 包装连接在 SQLite 删除一行数据，**Then** 审计表应记录删除前的数据，且目标数据库应在 5 秒内删除对应记录
4. **Given** 源库持续高并发写入（>100 TPS），**When** 增量同步运行中，**Then** 系统应保持稳定，审计表不溢出，不出现内存溢出或丢失变更
5. **Given** 审计表中有未消费记录，**When** CDC 后台线程轮询并消费，**Then** 消费成功后应标记为已处理（软删除或归档），断点应更新到最新位置

---

### 用户场景 3 - 字段名映射配置 (Priority: P2)

作为数据工程师，我需要配置源表字段与目标表字段的映射关系，以便应对源库和目标库表结构不完全一致的场景。

**为何此优先级**: 实际生产环境中，源库和目标库的表结构往往不完全一致。字段映射提高了方案的实用性和灵活性。

**独立测试**: 可以独立测试：配置字段映射文件，执行同步，验证数据按映射规则正确写入目标字段。

**验收场景**:

1. **Given** 配置文件中定义了 `source.users.name` → `target.users.user_name` 的映射，**When** 执行同步，**Then** 数据应写入目标表的 `user_name` 字段而非 `name` 字段
2. **Given** 配置文件中定义了字段转换规则（如类型转换、默认值），**When** 执行同步，**Then** 转换规则应正确应用
3. **Given** 某源表字段未在映射中定义，**When** 执行同步，**Then** 该字段应被忽略或按默认规则处理（根据配置）

---

### 用户场景 4 - CLI 独立运行 (Priority: P2)

作为运维人员，我需要通过命令行工具直接运行 CDC 同步，无需编写代码，以便快速部署和运维。

**为何此优先级**: CLI 工具降低了使用门槛，使非 Python 开发者也能使用该方案。同时方便脚本化和自动化运维。

**独立测试**: 可以独立测试：安装 CLI 工具，通过命令行参数或配置文件运行同步任务，验证功能完整可用。

**验收场景**:

1. **Given** 已通过 pip 安装工具，**When** 执行 `sqlite-cdc --config sync.yaml` 命令，**Then** 应启动同步进程并按配置执行
2. **Given** CLI 正在运行，**When** 发送 SIGTERM 信号，**Then** 进程应优雅关闭，不丢失正在处理的变更
3. **Given** 需要查看同步状态，**When** 执行 `sqlite-cdc status` 命令，**Then** 应显示当前同步进度、延迟、错误统计等信息

---

### 用户场景 5 - 同步失败告警 (Priority: P3)

作为系统管理员，我需要在同步失败时收到通知，以便及时介入处理，避免数据长期不一致。

**为何此优先级**: 失败告警是运维保障手段，非核心功能。系统应先保证能正确同步，再考虑失败时的通知机制。

**独立测试**: 可以独立测试：配置告警方式，人为制造同步失败（如断开目标库连接），验证告警消息正确送达。

**验收场景**:

1. **Given** 配置了日志告警，**When** 同步遇到错误（如目标库连接失败），**Then** 应在日志中输出 ERROR 级别告警信息，包含错误详情
2. **Given** 配置了 Webhook 告警，**When** 同步连续失败超过阈值（如 3 次），**Then** 应调用 Webhook 发送告警通知
3. **Given** 同步失败持续发生，**When** 后台监控系统轮询日志，**Then** 应能解析 ERROR 级别的同步错误信息并触发告警（为后续管理界面暴露告警功能预留扩展点）

---

### 用户场景 6 - PyPI 库集成 (Priority: P3)

作为 Python 开发者，我需要将 CDC 功能集成到自己的 Python 应用中，以便灵活控制同步行为和与业务逻辑联动。

**为何此优先级**: 库模式提供了最大的灵活性，但使用门槛较高。作为三方库发布是本需求的组成部分，但集成能力是进阶功能。

**独立测试**: 可以独立测试：pip 安装库，在 Python 代码中导入并初始化 CDC 引擎，验证 API 功能正常。

**验收场景**:

1. **Given** 已通过 `pip install sqlite-cdc` 安装，**When** 在 Python 代码中 `from sqlite_cdc import SyncEngine`，**Then** 应成功导入并可用
2. **Given** 在 Python 代码中创建了 SyncEngine 实例，**When** 调用 `engine.start()` 方法，**Then** 应启动后台同步线程/进程
3. **Given** 同步运行中，**When** 调用 `engine.get_status()` 方法，**Then** 应返回当前同步状态和统计信息
4. **Given** 需要自定义处理逻辑，**When** 注册回调函数 `engine.on_sync_event(callback)`，**Then** 每个同步事件应触发回调并传递事件详情

---

### 边界情况

- 当审计日志表 `_cdc_audit_log` 增长过快时，系统如何处理（归档/清理策略）？
- 当目标数据库连接断开超过 1 小时，系统如何恢复同步？
- 当应用绕过 CDC 连接包装器直接写入 SQLite（非审计模式），如何确保变更不遗漏？
- 当事务批量提交大量变更（>10000 行）时，审计表和系统性能如何保证？
- 当源表和目标表的字段类型不兼容时（如 SQLite 的 TEXT 到 Oracle 的 DATE），如何处理？
- 当审计表消费失败且重试超过最大次数，如何处理（死信、告警、人工介入）？

## 澄清记录

### Session 2026-02-07

- **Q**: WAL 监听技术方案选择 → **A**: ~~采用 WAL 文件监听方案~~ **【已废弃】** 因 WAL 格式解析风险过高，改用审计日志方案
- **Q**: 存量同步执行策略 → **A**: 采用方案 A - 先存量后增量（串行模式）
- **Q**: 多目标同步策略 → **A**: 采用方案 B - 并行写入多目标（多消费者模式）
- **Q**: exactly-once 断点存储策略 → **A**: 采用方案 B - 基于审计日志序列号 + UPSERT 幂等写入
- **Q**: 增量捕获技术方案 → **A**: 采用审计日志方案（Audit Log）：拦截应用层写入，将变更记录到审计表，后台线程异步消费

### 架构变更说明

**变更原因**: WAL 文件直接解析存在以下不可接受的风险：
1. SQLite WAL 格式复杂且未公开稳定规范
2. 需要大量逆向工程工作
3. 版本兼容性风险（格式可能随 SQLite 升级变化）
4. 无法直接获取变更前后的行数据（需要解析 B-tree 页）

**新方案 - 审计日志模式**：
- 在应用层拦截 SQLite 写入操作
- 将变更记录写入 `_cdc_audit_log` 表（与业务数据同一事务）
- 后台线程轮询审计表，批量消费并同步到目标库
- 使用审计表自增 ID 作为断点，保证 exactly-once

## 需求

### 功能需求

- **FR-001**: 系统必须支持 SQLite 到 MySQL 的数据同步
- **FR-002**: 系统必须支持 SQLite 到 Oracle 的数据同步
- **FR-003**: 系统必须支持存量数据的全量初始同步
- **FR-004**: 系统必须支持基于审计日志的实时增量同步（通过 `_cdc_audit_log` 表）
- **FR-005**: 系统必须保证最终一致性（允许短暂不一致，但最终会收敛）
- **FR-006**: 同步过程必须异步执行，不能阻塞或显著影响源 SQLite 数据库的写入性能
- **FR-007**: 系统必须在同步失败时提供结构化日志告警（ERROR 级别），包含错误详情；可选支持 Webhook 回调（配置化开关）
- **FR-008**: 系统必须支持配置文件或 API 方式定义字段名映射规则
- **FR-009**: 系统必须提供 CLI 命令行接口，支持独立运行
- **FR-010**: 系统必须可作为 PyPI 三方库安装和集成
- **FR-011**: 系统必须支持同步位置（offset/checkpoint）的持久化，支持断点续传
- **FR-012**: 系统必须支持优雅关闭，确保正在处理的事务完成后再退出

### 关键实体

- **SyncConfig（同步配置）**: 包含源数据库连接信息、目标数据库连接信息、表映射规则、同步模式（存量/增量）等配置项
- **TableMapping（表映射）**: 定义源表与目标表的对应关系，包含字段映射、过滤条件、转换规则
- **FieldMapping（字段映射）**: 定义源字段到目标字段的映射，支持字段名转换、类型转换、默认值
- **SyncPosition（同步位置）**: 记录当前同步进度，包括已处理的审计日志序列号（`audit_log.id`），用于断点续传
- **ChangeEvent（变更事件）**: 从 `_cdc_audit_log` 表解析的单行变更记录，包含操作类型（INSERT/UPDATE/DELETE）、表名、变更前/后的数据
- **SyncEngine（同步引擎）**: 核心控制器，协调审计日志轮询、事件解析、目标库写入等组件
- **CDCConnection（CDC连接包装器）**: 包装 SQLite 连接，拦截 INSERT/UPDATE/DELETE 操作并写入审计表
- **AuditLog（审计日志表）**: `_cdc_audit_log` 表，存储所有数据变更记录，包含自增 ID、表名、操作类型、变更数据、时间戳等

## 成功标准

### 可衡量的成果

- **SC-001**: 存量同步阶段，用户可以在 10 分钟内完成配置并开始同步 100 万行数据的初始复制
- **SC-002**: 增量同步阶段，从 SQLite 变更发生到目标库可见的平均延迟应小于 5 秒（在 100 TPS 负载下）
- **SC-003**: 同步过程对源 SQLite 数据库的写入性能影响应小于 5%（对比无 CDC 时的基准性能）
- **SC-004**: 95% 的用户可以在首次尝试时成功完成 CLI 配置并启动同步，无需查阅额外文档
- **SC-005**: 在发生网络中断等故障后，系统在恢复连接后能自动从断点续传，无需人工干预
- **SC-006**: 在持续运行 7 天后，数据校验（源库 vs 目标库行数和关键字段哈希）应显示 100% 一致
